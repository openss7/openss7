<html>



<head>

<title>Drivers</title>
<meta name="title" content="Drivers">
<meta name="keywords" content="Linux, streams, drivers, LiS">
<meta name="description" content="LiS Drivers">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<style type="text/css">

<!--

h2 {  font-family: Arial, Helvetica, sans-serif}

h1 {  font-family: Arial, Helvetica, sans-serif}

h3 {  font-family: Arial, Helvetica, sans-serif}

p {  font-family: Arial, Helvetica, sans-serif; font-size: 12pt}

a {  font-family: Arial, Helvetica, sans-serif; color: #0000FF}

a:link {  font-family: Arial, Helvetica, sans-serif; color: #0000FF}

a:hover {  font-family: Arial, Helvetica, sans-serif; color: #FF3333}

li {  font-family: Arial, Helvetica, sans-serif; font-size: 10pt}

ol {  font-family: Arial, Helvetica, sans-serif; font-size: 10pt}

-->

</style>

<script language="JavaScript">

<!--

function MM_swapImgRestore() { //v3.0

  var i,x,a=document.MM_sr; for(i=0;a&&i<a.length&&(x=a[i])&&x.oSrc;i++) x.src=x.oSrc;

}



function MM_preloadImages() { //v3.0

  var d=document; if(d.images){ if(!d.MM_p) d.MM_p=new Array();

    var i,j=d.MM_p.length,a=MM_preloadImages.arguments; for(i=0; i<a.length; i++)

    if (a[i].indexOf("#")!=0){ d.MM_p[j]=new Image; d.MM_p[j++].src=a[i];}}

}



function MM_findObj(n, d) { //v3.0

  var p,i,x;  if(!d) d=document; if((p=n.indexOf("?"))>0&&parent.frames.length) {

    d=parent.frames[n.substring(p+1)].document; n=n.substring(0,p);}

  if(!(x=d[n])&&d.all) x=d.all[n]; for (i=0;!x&&i<d.forms.length;i++) x=d.forms[i][n];

  for(i=0;!x&&d.layers&&i<d.layers.length;i++) x=MM_findObj(n,d.layers[i].document); return x;

}



function MM_swapImage() { //v3.0

  var i,j=0,x,a=MM_swapImage.arguments; document.MM_sr=new Array; for(i=0;i<(a.length-2);i+=3)

   if ((x=MM_findObj(a[i]))!=null){document.MM_sr[j++]=x; if(!x.oSrc) x.oSrc=x.src; x.src=a[i+2];}

}

//-->

</script>

</head>







<body bgcolor="#FFFFFF" onLoad="MM_preloadImages('i/kernel_on.gif','i/download_on.gif','i/install_on.gif','i/removal_on.gif','i/loading_on.gif','i/drivers_on.gif','i/config_on.gif','i/demand_on.gif','i/compiled_on.gif','i/apps_on.gif','i/otherres_on.gif','i/command_on.gif','i/dki_on.gif','i/libs_on.gif','i/lisdrvrs_on.gif')">
<table width="700" border="0" cellspacing="0" cellpadding="0" height="120" bgcolor="#6666CC">

	 <tr> 

		  <td width="120" height="120" rowspan="3"><a href="index.html"><img src="i/penguin.gif" width="120" height="120" border="0"></a></td>

		  <td rowspan="3" width="570" height="120" align="center" valign="middle"> 

			   <h1><font color="#FFFFFF" style="font-size:30pt;">Linux STREAMS (LiS)</font></h1>

			 </td>

		  <td bgcolor="#ffffff" rowspan="3" width="10" height="120"><img src="./i/sideborder.gif" width="10" height="130"></td>

	 </tr>

	 <tr> </tr>

	 <tr> </tr>

</table>

<img src="./i/bottomborder.gif" width="703" height="15"> <br>

<table width="700" border="0" cellspacing="0" cellpadding="0">

  <tr> 

    <td rowspan="2" width="100" align="left" valign="top"> 
      <table width="90" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td><a href="kernel.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('kernel','','i/kernel_on.gif',1)"><img name="kernel" border="0" src="i/kernel_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="download.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('download','','i/download_on.gif',1)"><img name="download" border="0" src="i/download_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="install.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('install','','i/install_on.gif',1)"><img name="install" border="0" src="i/install_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="removal.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('removal','','i/removal_on.gif',1)"><img name="removal" border="0" src="i/removal_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="loading.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('loading','','i/loading_on.gif',1)"><img name="loading" border="0" src="i/loading_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="drivers.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('drivers','','i/drivers_on.gif',1)"><img name="drivers" border="0" src="i/drivers_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="config.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('config','','i/config_on.gif',1)"><img name="config" border="0" src="i/config_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="demand.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('demand','','i/demand_on.gif',1)"><img name="demand" border="0" src="i/demand_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="compiled.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('compiled','','i/compiled_on.gif',1)"><img name="compiled" border="0" src="i/compiled_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="apps.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('apps','','i/apps_on.gif',1)"><img name="apps" border="0" src="i/apps_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="otherres.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('otherres','','i/otherres_on.gif',1)"><img name="otherres" border="0" src="i/otherres_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="cmds.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('cmds','','i/command_on.gif',1)"><img name="cmds" border="0" src="i/command_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="dki.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('dki','','i/dki_on.gif',1)"><img name="dki" border="0" src="i/dki_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="libc.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('libs','','i/libs_on.gif',1)"><img name="libs" border="0" src="i/libs_off.gif" width="81" height="35"></a></td>
        </tr>
        <tr> 
          <td><a href="drvrs.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('lisdrvrs','','i/lisdrvrs_on.gif',1)"><img name="lisdrvrs" border="0" src="i/lisdrvrs_off.gif" width="81" height="35"></a></td>
        </tr>
      </table>
    </td>

    <td width="600" height="75"> 

      <div align="center"> 

        <h2>Coding LiS Drivers</h2>

      </div>

    </td>

  </tr>

  <tr> 
    <td width="600" height="100%" align="left" valign="top"> 
      <p>This document is concerned with the include files and compilation techniques 
        for STREAMS drivers. It is not intended to be a tutorial on the subject 
        of writing STREAMS drivers. Additional resources are available <a

        href="otherres.html">here</a> for reference material. Please consult the 
        <a href="dki.html">Driver/Kernel Interface </a>section for information 
        about how drivers interact with LiS and the Linux kernel for system services.</p>
      <h2><font size="4">Header Files</font> </h2>
      <p>In your C language source file for a STREAMS driver, you should place 
        the following line of code. </p>
      <blockquote> 
        <p><code>#include &lt;sys/stream.h&gt;</code> </p>
      </blockquote>
      <p>This line will include all of the additional header files and function 
        prototypes needed to code a STREAMS driver. </p>
      <p>If your STREAMS driver needs to decode the flush bits in M_FLUSH messages 
        then also include the following. </p>
      <blockquote> 
        <p><code>#include &lt;sys/stropts.h&gt;</code> </p>
      </blockquote>
      <p>If your driver uses some of the portable <a href="/dev_web/linux/lis/dki.html">Driver 
        Kernel Interface</a> (DKI) features of LiS you may need to include some 
        additional header files.</p>
      <h2><font size="4">Compilation Options</font> </h2>
      <p>When you compile your STREAMS driver, put the following compiler option 
        on the gcc (cc) command line for each C language file that contains one 
        or the other of the above include lines. </p>
      <blockquote> 
        <p><code>-I/usr/src/LiS/include -D__KERNEL__ -DLINUX</code> </p>
      </blockquote>
      <p>This directive assumes that you used standard installation procedures 
        for LiS so that the name <font face="Courier New, Courier, mono">/usr/src/LiS</font> 
        is a symbolic link to the LiS installation directory. The <font face="Courier New, Courier, mono">-D</font>'s 
        are necessary to give your driver the kernel's view of the header files 
        and to get the Linux version in those cases where alternatives exist. 
      </p>
      <h2><font size="4">Driver Prefix</font> </h2>
      <p>Choose a short prefix to put on the front of all your identifier names 
        and routine names. For example, &quot;<font face="Courier New, Courier, mono">xylo_</font>&quot;. 
        Thus, the main streamtab entry for your driver would be: </p>
      <pre>

struct streamtab xylo_info =

    {

      &amp;xylo_rinit,                  /* read queue */
      &amp;xylo_winit,                  /* write queue */
      NULL,                         /* mux read queue  */
      NULL                          /* mux write queue */
    };

</pre>
      <p>The open routine would be called &quot;<font face="Courier New, Courier, mono">xylo_open(....)</font>&quot; 
        and so on. </p>
      <p>The role of this prefix is to allow the LiS <a

        href="config.html">configuration</a> process to build some tables that 
        reference certain symbols within your driver. Just to take one example, 
        the &quot;<i>prefix</i><font face="Courier New, Courier, mono">info</font>&quot; 
        structure's name must be known to LiS so that it can build the queue structures 
        that are passed to your driver at open time. </p>
      <h2><font size="4">Driver Open Routine</font> </h2>
      <p>It is important that you get the declaration of your driver open routine 
        correct. There was a different prototype for the open routine in SVR 3 
        versus SVR 4. The Linux STREAMS package uses the SVR 4 style only. The 
        prototype for your open routine should be as follows: </p>
      <blockquote> 
        <pre><code>int xylo_open(queue_t *q, dev_t *dev, 
              int oflag, int sflag, cred_t *cred_p);</code> </pre>
      </blockquote>
      <p>These prototypes can be found in the DDI/DKI or consult the LiS include 
        file <font face="Courier New, Courier, mono">include/sys/LiS/queue.h</font>. 
        Look for the definition of the structure <font face="Courier New, Courier, mono">qinit_t</font>. 
      </p>
      <h2><font size="4">Driver Registration</font> </h2>
      <p>Your driver will be automatically registered with the Linux kernel as 
        a character mode special device driver if it is linked in with LiS. The 
        LiS configuration process builds tables that allow LiS to perform this 
        registration function on behalf of your driver. Thus, your STREAMS drivers 
        should not contain any code to register itself as a Linux driver.</p>
      <p>If your driver is to be <a href="demand.html">loaded separately</a> there 
        are some special considerations that apply.</p>
      <p>&nbsp; </p>
    </td>

  </tr>

</table>

<p align="left">&nbsp;</p>



</body>



</html>



