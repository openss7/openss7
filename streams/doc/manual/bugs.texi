@c -*- texinfo -*- vim: ft=texinfo tw=100 nocin nosi
@c =========================================================================
@c
@c @(#) $Id: bugs.texi,v 0.9.2.29 2009-04-21 07:48:38 brian Exp $
@c
@c =========================================================================
@c
@c Copyright (c) 2008-2009  Monavacon Limited <http://www.monavacon.com/>
@c Copyright (c) 2001-2008  OpenSS7 Corporation <http://www.openss7.com/>
@c Copyright (c) 1997-2001  Brian F. G. Bidulock <bidulock@openss7.org>
@c
@c All Rights Reserved.
@c
@c Permission is granted to make and distribute verbatim copies of this
@c manual provided the copyright notice and this permission notice are
@c preserved on all copies.
@c
@c Permission is granted to copy and distribute modified versions of this
@c manual under the conditions for verbatim copying, provided that the
@c entire resulting derived work is distributed under the terms of a
@c permission notice identical to this one.
@c 
@c Since the Linux kernel and libraries are constantly changing, this
@c manual page may be incorrect or out-of-date.  The author(s) assume no
@c responsibility for errors or omissions, or for damages resulting from
@c the use of the information contained herein.  The author(s) may not
@c have taken the same level of care in the production of this manual,
@c which is licensed free of charge, as they might when working
@c professionally.
@c 
@c Formatted or processed versions of this manual, if unaccompanied by
@c the source, must acknowledge the copyright and authors of this work.
@c
@c -------------------------------------------------------------------------
@c
@c U.S. GOVERNMENT RESTRICTED RIGHTS.  If you are licensing this Software
@c on behalf of the U.S. Government ("Government"), the following
@c provisions apply to you.  If the Software is supplied by the Department
@c of Defense ("DoD"), it is classified as "Commercial Computer Software"
@c under paragraph 252.227-7014 of the DoD Supplement to the Federal
@c Acquisition Regulations ("DFARS") (or any successor regulations) and the
@c Government is acquiring only the license rights granted herein (the
@c license rights customarily provided to non-Government users).  If the
@c Software is supplied to any unit or agency of the Government other than
@c DoD, it is classified as "Restricted Computer Software" and the
@c Government's rights in the Software are defined in paragraph 52.227-19
@c of the Federal Acquisition Regulations ("FAR") (or any successor
@c regulations) or, in the cases of NASA, in paragraph 18.52.227-86 of the
@c NASA Supplement to the FAR (or any successor regulations).
@c
@c =========================================================================
@c 
@c Commercial licensing and support of this software is available from
@c OpenSS7 Corporation at a fee.  See http://www.openss7.com/
@c 
@c =========================================================================
@c
@c Last Modified $Date: 2009-04-21 07:48:38 $ by $Author: brian $
@c
@c =========================================================================

@table @code
@item 028.  2009-04-17T11:56:06+0000

The strace, strerr daemons and the pstrlog call in the streams library were not initializing ltime
before the call to ctime_r() resulting in an epoch timestamp (Jan 1, 1970).  Thanks to Pierre
Crepieux for identifying and reporting this bug.

@emph{*fixed*} in @command{streams-0.9.2.5}

@item 027.  2009-03-26T07:56:40+0000

Untimeout and unbufcall did not wait until the callback returned before returning when there was a
collision between a cancellation of an event and the callback for the event.  Linux Fast-STREAMS now
makes this assurance, provided that the cancellation is not being invoked from within the same
thread as the callback (i.e. untimeout called from an ISR interrupting the callback, or, say, from
the callback itself) in which case it returns immediately.

Also, additional timer problems were encountered.  Cancelling timers from within an ISR did not have
sufficient list protection (irq suppression) potentially resulting in list corruption or queue
reference counting problem.

@emph{*fixed*} in @command{streams-0.9.2.5}

@item 026.  2008-12-16T08:17:47+0000

Somewhere about Linux kernel @samp{2.6.17}, and during the openss7-0.9.2.D.rc2 master package
release, it was discovered that SLABs no longer supported the SLAB_NO_REAP flag.  Unfortunately,
the @command{seinfo_ctor()} function was assuming that the SLAB_NO_REAP flag was being recognized.
This means that over the span of some several days on system heavily using timers that a slab
corruption would eventually occur resulting in a kernel crash, particularly on x86_64 kernels.
The @samp{seinfo} slab functions have been rewritten to not expect the SLAB_NO_REAP feature.
There was also a minor possibility of a strevent structure identifier overlap after an extremely
long period of intensive operation, and that has been fixed as well.  Thanks to Angel Diaz for
reporting this bug.

@emph{*fixed*} in @command{streams-0.9.2.5}

@item 025.  2008-10-17T05:57:29+0000

@samp{putnext(q, mp)} was checking whether procedures had been turned off on queue @samp{q}.  This
was not correct as it is only the @samp{q->q_next} put procedure that would be executed.  It should
only check procedures on @samp{q->q_next}.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 024.  2008-10-11T19:36:41+0000

A list delete corruption bug in the STREAMS driver and module lookup functions (e.g.
@command{__cdrv_lookup}) was discovered by the list debugging in the @cite{FC9} kernel.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 023.  2008-10-11T19:36:23+0000

Not really a bug, but newer (2.6.25) kernels no longer permit registration of binary identifiers for
sysctls (i.e. @member{ctl_name}).  The proc filesystem entries (i.e. @member{procname}) are still
permitted and @member{ctl_name} should be set to zero for these kernels.  Added a check for the
existence of symbol @command{sysctl_check_table()} to identify when binary registration is
forbidden.  Another related problem is that when binary registration of system controls is not
possible, @manref{sysctl(2)} becomes worthless.  Unfortunately, the STREAMS MIB agent was written to
use @manref{sysctl(2)} and needs to be rewritten to use the @file{/proc/sys} filesystem instead ala
@manref{sysctl(8)}.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 022.  2008-10-07T18:40:25+0000

When overriding 32-bit compatability on input-output controls conflicting from the CDROM block
device with STREAMS input-output controls, the override was not properly passing CDROM input-output
controls through due to a missing break statement in the override loop.  This bug affected
pre-2.6.11 kernels, likely manifesting itself in a non-function CDROM device while STREAMS was
loaded.  Bug reported and one-line fix provided by Sylvain Chouleur for @cite{DGAC}.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 021.  2008-08-01T22:32:08+0000

When flushing queues the backenable bits were not being initialized to zero in @command{__flushq()},
resulting in back-enabling of bands (or the normal queue) was being performed depending on the
uninitialized values in the backenable bit array.  This only affected @streamio{I_SETSIG} signals
for @constant{SWRNORM} and @constant{SWBAND}, and the only when flushing queues.  Fix properly
initializes the backenable array.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 020.  2008-07-31T04:59:41+0000

Not really a bug (for @cite{STREAMS}), but when the @file{streams.ko} kernel module is loaded, the
@mantype{crash(8)} debugger will not debug a running kernel because it finds the
@command{runqueues()} exported function in the @file{streams.ko} module instead of the the static
one from the kernel.  This has been temporarily renamed by macro to @command{srunqueues()} (notice
the leading @samp{s}) until @mantype{crash(8)} learns to do the right thing and check that the
symbol it looks up comes from the kernel instead of a kernel module.

@emph{*workaround*} in @command{streams-0.9.2.4}

@item 019.  2008-07-25T22:41:47+0000

When @msg{M_READ} was being issued by the Stream Head downstream an @command{srlock()} imbalance in
@command{strsendmread()} was causing soft-lockups on close for recent read-write lock
implementations on @cite{CentOS 5.2} for @samp{x86_64}.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 018.  2008-07-25T01:15:26+0000

Previous fix didn't work too good: returning @errno{EAGAIN} when hung-up on @manref{getmsg(2)},
@manref{getpmsg(2)}, @manref{read(2)}, @manref{readv(2)} instead of 0 and terminal end of file.
This caused a regression on four or five other test cases.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 017.  2008-04-10T15:17:30+0000

When @msg{M_DATA} is sent upstream followed by @msg{M_HANGUP}, @manref{read(2s)} is returning zero
(0) and not permitting the data associated with the @msg{M_DATA} to be read.  This is a bug per
documentation.  @manref{read(2s)} should operate as normal following a hangup until all data is read
and then return zero (0).

The difficulty is that when waking up from a read sleep or when entering read the hangup condition
was generating an internal @errno{ESTRPIPE} error.  This was altered so that @errno{ESTRPIPE} is
only returned during the hangup condition after the read queue has been tested and the caller is
about to sleep on read.

Test cases 3.2.1, 3.5.1 and 3.6.1 in the test-streams test suite executable were altered to validate
the fix for this case and curtail regressions.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 016.  2007-11-14T17:23:57+0000

Read is blocking when data has been read, @constant{O_NONBLOCK} and @constant{O_NDELAY} unset,
@constant{RFILL} unset, in non-SVR4 mode.  This violates POSIX specifications.

Test case 3.1.11.4 in the test-streams test suite executable was generated to validate the fix
for this case and to curtail regressions.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 015.  2007-11-14T17:19:01+0000

Dynamic allocation of major device numbers is not working on recent 2.6 kernels.  Someone slipped
some code in the kernel to have register_chrdev() allocate from major 255 down (again).  Changed
code to allocate modid according to our own rules and then request the same for a major device
number.  This also ensures that module ID and major are the same.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 014.  2007-05-17T21:48:24+0000

The @manref{dupb(9)} utility had an obnoxious bug where it permitted the @member{db_ref} count to
wrap to zero, causing buffer allocation and freeing problems.  This was very difficult to debug.
@manref{dupb(9)} now fails if the reference count has reached 255.  When @manref{dupb(9)} fails, the
user should check if the reference count has reached 255, and if it has, attempt a deep
@manref{copyb(9)} instead.  At some point it might be useful to have STREAMS do the deep copy
automatically.  This was discovered in @file{strsctp} loopback tests where message blocks are
rapidly duplicated for retransmission.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 013.  2007-05-17T21:48:06+0000

The log driver, strace, strerr and strclean utilities had some bugs.  The @file{strsctp} driver now
makes extensive use of @manref{strlog(9)} trace and error logging and the log driver and utilities
have been corrected.  These facilities are now production grade.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 012.  2007-04-13T01:47:30+0000

It appears that @cite{Ubuntu 6.10} has a rather broken implementation of the LSB
@command{install_init} that has been inherited from Debian (a python script, none the less).  This
implementation refuses to properly install a disabled service (one with an empty or missing
Default-Start: tag), but, rather invokes updated-rc.d in such a way that the init script is started
at runlevels @samp{2 3 4 5} instead.  This was causing problems with the strace and strerr services
which are normally installed disabled.

This uncovered the fact that the Debian-style init scripts were not working anyway.  The scripts
have been fixed and the strace and strerr utilities now default to enabled.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 011.  2007-04-10T10:56:42+0000

The strbcflag flag was never being cleared, causing infinite looping of the scheduler once the
maximum number of buffers was reached.  This also revealed a problem that bufcalls were being run
unncecessarily (when strbcwait was set, instead of only when strbcflag was set).

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 010.  2007-04-10T10:55:29+0000

The stream event sequence number was wrapping and becoming larger than the event mask resulting in
inability to cancel buffer callbacks and timeouts.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 009.  2007-04-02T11:57:35+0000

@file{ldl} was using an incorrect MKDEV command, but when the Stream head attempted to redirect the
open to the new (mangled) major device number, it properly returned ENXIO, but did not release a
reference to the module.  Need to check code paths for this to see where the reference needed to be
released.

@emph{*known bug*}

@item 008.  2007-03-31T05:33:29-0600

When loosening SMP locking, found a bug in the QWANTR handling in getq() and back-enabling in
flushq() and flushband().  Both of these were generating false back-enables.  The getq() was
generating a @emph{lot} of false back-enables.  Whenever getq() found an empty queue it was not only
setting QWANTR, but it was back-enabling the queue.  The result is that if service procedures are
used exclusively (that is, qi_put() always does a putq()), getq() would generate a false back-enable
for each message.  Also, the enabled queue would generate another false back-enable.  Significant
performance gains should be noticed.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 007.  2007-03-16T17:33:20-0600

@iftex
J@'er@'emy
@end iftex
@ifnottex
Jérémy
@end ifnottex
Compostella pointed out an error in strallocpmsg() where it was always assigining M_PCPROTO to
messages created with I_FDINSERT.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 006.  2007-03-14T23:48:26-0600

There appears to be an inode lock imbalance that occurred for several clone error paths in stropen.
If the returned major device number does not correspond to a driver, or an snode cannot be acquired
for the new entry and the stream head reparented.

@emph{*fixed*} in @command{streams-0.9.2.2}

@item 005.  2007-03-07T15:53:06-0700

Demand loading of kernel modules for clone devices opened, for example, as /dev/streams/clone/mux
was requesting module streams-clone-mux and /dev/streams/clone/mux but was not requesting
streams-mux or /dev/streams/mux and the modules were failing to demand load.

@emph{*fixed*} in @command{streams-0.9.2.2}

@item 004. 2007-02-26T08:25:09-0700

@iftex
J@'er@'emy
@end iftex
@ifnottex
Jérémy
@end ifnottex
Compostella pointed out error in clone.c.  When an automatic clone minor device was unregistered, it
was unregistering the modid instead of the major number.  This was not noticed because all OpenSS7
drivers have the same modid as major number (strconf does this automatically).

@emph{*fixed*} in @command{streams-0.9.2.2}

@item 003. 2007-02-26T08:25:09-0700

@iftex
J@'er@'emy
@end iftex
@ifnottex
Jérémy
@end ifnottex
Compostella pointed out syntax error in strsched.c that kept synqs from compiling properly.

@emph{*fixed*} in @command{streams-0.9.2.2}

@item 002. 2006-09-24T20:02:00+0000

Discovered asynchronous thread cancellation inconsistencies in libLiS libpLiS by inspection during
documentation.  @manref{isastream(2)}, @manref{fattach(2)} were not performing proper asynchronous
thread cancellation suppression so that these function contained a cancellation point when the
should not.

@emph{*fixed*} in @command{streams-0.7a.6.rc3}

@item 001. 2006-07-05T21:54:49+0000

Fedora Core 5 reports a rwlock bug during udp module unloading as follows:

@example
BUG: rwlock wrong CPU on CPU#0, rmmod/7515
Call Trace:
  @{rwlock_bug+100@}
  @{_raw_write_unlock+88@}
  @{:streams:unregister_strnod+211@}
  @{:streams:unregister_clone+64@}
  @{:streams:unregister_strdev+24@}
  @{:streams_udp:udpterminate+26@}
  @{sys_delete_module+406@}
  @{system_call+126@}
@end example

It appears that unregister_strnod() is scheduling while holding a write lock on cdevsw_lock.  This
is probably in iput() called within cmin_del.

@emph{*fixed*} in @command{streams-0.7a.6.rc2}

There were a number of places where sleeping functions were called with spin-locks held, causing the
CPU awaking from the sleep to sometimes be different from the CPU that took the lock.  This was
buggy, so I reworked all of these cdev and fmod sections to handle spin locks properly.  FC5/SMP on
HT no longer reports these bugs.
@end table

