@c -*- texinfo -*- vim: ft=texinfo
@c =========================================================================
@c
@c @(#) $Id: bugs.texi,v 0.9.2.19 2008/07/25 23:07:00 brian Exp $
@c
@c =========================================================================
@c
@c Copyright (c) 2001-2008  OpenSS7 Corporation <http://www.openss7.com/>
@c
@c All Rights Reserved.
@c
@c Permission is granted to make and distribute verbatim copies of this
@c manual provided the copyright notice and this permission notice are
@c preserved on all copies.
@c
@c Permission is granted to copy and distribute modified versions of this
@c manual under the conditions for verbatim copying, provided that the
@c entire resulting derived work is distributed under the terms of a
@c permission notice identical to this one.
@c 
@c Since the Linux kernel and libraries are constantly changing, this
@c manual page may be incorrect or out-of-date.  The author(s) assume no
@c responsibility for errors or omissions, or for damages resulting from
@c the use of the information contained herein.  The author(s) may not
@c have taken the same level of care in the production of this manual,
@c which is licensed free of charge, as they might when working
@c professionally.
@c 
@c Formatted or processed versions of this manual, if unaccompanied by
@c the source, must acknowledge the copyright and authors of this work.
@c
@c -------------------------------------------------------------------------
@c
@c U.S. GOVERNMENT RESTRICTED RIGHTS.  If you are licensing this Software
@c on behalf of the U.S. Government ("Government"), the following
@c provisions apply to you.  If the Software is supplied by the Department
@c of Defense ("DoD"), it is classified as "Commercial Computer Software"
@c under paragraph 252.227-7014 of the DoD Supplement to the Federal
@c Acquisition Regulations ("DFARS") (or any successor regulations) and the
@c Government is acquiring only the license rights granted herein (the
@c license rights customarily provided to non-Government users).  If the
@c Software is supplied to any unit or agency of the Government other than
@c DoD, it is classified as "Restricted Computer Software" and the
@c Government's rights in the Software are defined in paragraph 52.227-19
@c of the Federal Acquisition Regulations ("FAR") (or any successor
@c regulations) or, in the cases of NASA, in paragraph 18.52.227-86 of the
@c NASA Supplement to the FAR (or any successor regulations).
@c
@c =========================================================================
@c 
@c Commercial licensing and support of this software is available from
@c OpenSS7 Corporation at a fee.  See http://www.openss7.com/
@c 
@c =========================================================================
@c
@c Last Modified $Date: 2008/07/25 23:07:00 $ by $Author: brian $
@c
@c =========================================================================

@table @code
@item 019.  2008-07-25T22:41:47+0000

When M_READ was being issued by the Stream Head downstream an srlock() imbalance in strsendmread()
was causing soft-lockups on close for recent read-write lock implementations on CentOS 5 for x86_64.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 018.  2008-07-25T01:15:26+0000

Previous fix didn't work too good: returning [EAGAIN] when hung-up on getmsg(), getpmsg(), read(),
readv() instead of 0 and terminal end of file.  This caused a regression on four or five test cases.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 017.  2008-04-10T15:17:30+0000

When M_DATA is sent upstream followed by M_HANGUP, read(2s) is returning zero (0) and not permitting
the data associated with the M_DATA to be read.  This is a bug per documentation.  read(2s) should
operate as normal following a hangup until all data is read and then return zero (0).

The difficulty is that when waking up from a read sleep or when entering read the hangup condition
was generating an internal ESTRPIPE error.  This was altered so that ESTRPIPE is only returned
during the hangup condition after the read queue has been tested and the caller is about to sleep on
read.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 016.  2007-11-14T17:23:57+0000

Read is blocking when data has been read, O_NONBLOCK and O_NDELAY unset, RFILL unset, in non-SVR4
mode.  This violates POSIX specifications.

A test case needs to be generated for this case and the fix needs to be implemented.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 015.  2007-11-14T17:19:01+0000

Dynamic allocation of major device numbers is not working on recent 2.6 kernels.  Someone slipped
some code in the kernel to have register_chrdev() allocate from major 255 down (again).  Changed
code to allocate modid according to our own rules and then request the same for a major device
number.  This also ensures that module ID and major are the same.

@emph{*fixed*} in @command{streams-0.9.2.4}

@item 014.  2007-05-17T21:48:24+0000

The dupb() utility had an obnoxious bug where it permitted the db_ref count to wrap to zero, causing
buffer allocation and freeing problems.  This was very difficult to debug.  dupb() now fails if the
reference count has reached 255.  When dupb() fails, the user should check if the reference count
has reached 255, and if it has, attempt a deep copyb() instead.  At some point it might be useful to
have STREAMS do the deep copy automatically.  This was discovered in strsctp loopback tests where
message blocks are rapidly duplicated for retransmission.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 013.  2007-05-17T21:48:06+0000

The log driver, strace, strerr and strclean utilities had some bugs.  The strsctp driver now makes
extensive use of strlog() trace and error logging and the log driver and utilities have been
corrected.  These facilities are now production grade.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 012.  2007-04-13T01:47:30+0000

It appears that Ubuntu 6.10 has a rather broken implementation of the LSB install_init that has been
inherited from Debian (a python script, none the less).  This implementation refuses to properly
install a disabled service (one with an empty or missing Default-Start: tag), but, rather invokes
updated-rc.d in such a way that the init script is started at runlevels 2 3 4 5 instead.  This was
causing problems with the strace and strerr services which are normally installed disabled.

This uncovered the fact that the Debian-style init scripts were not working anyway.  The scripts
have been fixed and the strace and strerr utilities now default to enabled.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 011.  2007-04-10T10:56:42+0000

The strbcflag flag was never being cleared, causing infinite looping of the scheduler once the
maximum number of buffers was reached.  This also revealed a problem that bufcalls were being run
unncecessarily (when strbcwait was set, instead of only when strbcflag was set).

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 010.  2007-04-10T10:55:29+0000

The stream event sequence number was wrapping and becoming larger than the event mask resulting in
inability to cancel buffer callbacks and timeouts.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 009.  2007-04-02T11:57:35+0000

@file{ldl} was using an incorrect MKDEV command, but when the Stream head attempted to redirect the
open to the new (mangled) major device number, it properly returned ENXIO, but did not release a
reference to the module.  Need to check code paths for this to see where the reference needed to be
released.

@emph{*known bug*}

@item 008.  2007-03-31T05:33:29-0600

When loosening SMP locking, found a bug in the QWANTR handling in getq() and back-enabling in
flushq() and flushband().  Both of these were generating false back-enables.  The getq() was
generating a @emph{lot} of false back-enables.  Whenever getq() found an empty queue it was not only
setting QWANTR, but it was back-enabling the queue.  The result is that if service procedures are
used exclusively (that is, qi_put() always does a putq()), getq() would generate a false back-enable
for each message.  Also, the enabled queue would generate another false back-enable.  Significant
performance gains should be noticed.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 007.  2007-03-16T17:33:20-0600

@iftex
J@'er@'emy
@end iftex
@ifnottex
Jérémy
@end ifnottex
Compostella pointed out an error in strallocpmsg() where it was always assigining M_PCPROTO to
messages created with I_FDINSERT.

@emph{*fixed*} in @command{streams-0.9.2.3}

@item 006.  2007-03-14T23:48:26-0600

There appears to be an inode lock imbalance that occurred for several clone error paths in stropen.
If the returned major device number does not correspond to a driver, or an snode cannot be acquired
for the new entry and the stream head reparented.

@emph{*fixed*} in @command{streams-0.9.2.2}

@item 005.  2007-03-07T15:53:06-0700

Demand loading of kernel modules for clone devices opened, for example, as /dev/streams/clone/mux
was requesting module streams-clone-mux and /dev/streams/clone/mux but was not requesting
streams-mux or /dev/streams/mux and the modules were failing to demand load.

@emph{*fixed*} in @command{streams-0.9.2.2}

@item 004. 2007-02-26T08:25:09-0700

@iftex
J@'er@'emy
@end iftex
@ifnottex
Jérémy
@end ifnottex
Compostella pointed out error in clone.c.  When an automatic clone minor device was unregistered, it
was unregistering the modid instead of the major number.  This was not noticed because all OpenSS7
drivers have the same modid as major number (strconf does this automatically).

@emph{*fixed*} in @command{streams-0.9.2.2}

@item 003. 2007-02-26T08:25:09-0700

@iftex
J@'er@'emy
@end iftex
@ifnottex
Jérémy
@end ifnottex
Compostella pointed out syntax error in strsched.c that kept synqs from compiling properly.

@emph{*fixed*} in @command{streams-0.9.2.2}

@item 002. 2006-09-24T20:02:00+0000

Discovered asynchronous thread cancellation inconsistencies in libLiS libpLiS by inspection during
documentation.  isastream(2), fattach(2) were not performing proper asynchronous thread cancellation
suppression so that these function contained a cancellation point when the should not.

@emph{*fixed*} in @command{streams-0.7a.6.rc3}

@item 001. 2006-07-05T21:54:49+0000

Fedora Core 5 reports a rwlock bug during udp module unloading as follows:

@example
BUG: rwlock wrong CPU on CPU#0, rmmod/7515
Call Trace:
  @{rwlock_bug+100@}
  @{_raw_write_unlock+88@}
  @{:streams:unregister_strnod+211@}
  @{:streams:unregister_clone+64@}
  @{:streams:unregister_strdev+24@}
  @{:streams_udp:udpterminate+26@}
  @{sys_delete_module+406@}
  @{system_call+126@}
@end example

It appears that unregister_strnod() is scheduling while holding a write lock on cdevsw_lock.  This
is probably in iput() called within cmin_del.

@emph{*fixed*} in @command{streams-0.7a.6.rc2}

There were a number of places where sleeping functions were called with spin-locks held, causing the
CPU awaking from the sleep to sometimes be different from the CPU that took the lock.  This was
buggy, so I reworked all of these cdev and fmod sections to handle spin locks properly.  FC5/SMP on
HT no longer reports these bugs.
@end table

